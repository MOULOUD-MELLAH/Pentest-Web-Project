<?php 

require_once('validateSession.php');
require_once("db.php");
require_once("login.php");

if (!empty($_POST['currentPassword']) && !empty($_POST['newPassword']) && !empty($_POST['newPasswordConfirm'])) {
  $currentPassword = $_POST['currentPassword'];
  $newPassword = sha1($_POST['newPassword']);
  $newConfirm = sha1($_POST['newPasswordConfirm']);
  if ($newPassword === $newConfirm) {
    $userId = $_SESSION['id'];
    $username = $_SESSION['username'];
    $sql = "UPDATE users SET password = '$newPassword' WHERE id = '$userId' AND username = '$username'";

    $result = mysqli_multi_query($db, $sql);
    
    if ($result) {
      echo "<script>alert('Mot de passe mis à jour');</script>";
    } else {
      echo "<script>alert('Le mot de passe n'a pas été mis à jour');</script>";
    }
  } else {
    echo "<script>alert('Mot de passe incompatible');</script>";
  }
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/settings.css">
    <title>设置</title>
</head>

<body style="background-image: url(assets/settings2.jpg);background-position: center; background-position: no-repeat;">
    <?php
    $page = "Settings";
    require_once("navbar.php");
  ?>
    <div class="topImg" >
    </div>
    <div class="card settingsCard" style="opacity: 0.95;">

        <div class="col-md-10 mx-auto text-center">
            <div class="headerTitle">
                <h1 class="mainTitle">
                    更改密码
                </h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md-10 mx-auto">
                <form method="post">
                    <div class="form-group">
                        <input name="currentPassword" type="password" class="form-control my-input" id="currentPassword"
                            placeholder="当前密码">
                    </div>
                    <div class="form-group">
                        <input name="newPassword" type="password" class="form-control my-input" id="newPassword"
                            placeholder="新密码">
                    </div>
                    <div class="form-group">
                        <input name="newPasswordConfirm" type="password" class="form-control my-input"
                            id="newPasswordConfirm" placeholder="确认密码">
                    </div>
                    <button class="btn btn-outline-dark btn-lg btn-block" type="submit">更新密码</button>
                </form>
            </div>
        </div>
    </div>

    </div>
</body>

</html>
