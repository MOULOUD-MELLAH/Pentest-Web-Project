<?php

function pwdMatch($pwd1, $pwd2) {
  $doesMatch = false;
  if ($pwd1 === $pwd2) {
    $doesMatch = true;
  }
  return $doesMatch;
}

foreach ($_POST as $cle=>$val){
$_POST[$cle]=stripslashes($val);
}

function createUser($db, $username, $password) {
 // $username=filter_var($username,FILTER_SANITIZE_STRING);
  //$password=filter_var($password,FILTER_SANITIZE_STRING);
  $sql = "INSERT INTO users (username, password) VALUES ('$username', '$password')";
  $resultStr = "";

  if (mysqli_multi_query($db, $sql)) {
    $resultStr = "成功创建: " . $username;
  } else {
    $resultStr = "无法创建新用户: " . mysqli_error($db);
  }
echo $resultStr;
  return $resultStr;
}


function loginUser($db, $username, $pwd) {
  $password = sha1($pwd);
  /*$username=addslashes($username); /*eviter sql injection*/

  $sql = "SELECT * FROM users WHERE username='$username' AND password='$password'";
  
  $result = mysqli_query($db, $sql);
  $count = mysqli_num_rows($result);

  $isLoggedIn = false;
  if ($count === 1) {
    $row = mysqli_fetch_array($result, MYSQLI_ASSOC);

    if ($row["userEnabled"]) {
      $id = $row["id"];
      $isAdmin = $row["isAdmin"];
      startSession($id, $username, $isAdmin);
      $isLoggedIn = true;
    } else {
      echo "<script>alert('用户帐户已禁用')</script>";
    }
  }

  return $isLoggedIn;
}

function startSession($id, $username, $isAdmin) {
  $_SESSION['username'] = $username;
  $_SESSION['id'] = $id;

  if ($isAdmin == "1") {
    $_SESSION['isAdmin'] = true;
    $_SESSION['indice'] = "0";
  }

  header("location: welcomePage.php");
}

?>
