<?php

include('validateSession.php');
require_once("db.php");
require_once("utils.php");


header("X-XSS-Protection: 1; mode=block");


if (!empty($_POST['delItemById']) ) {
  $id = $_POST['delItemById'];
  deleteItem($db, $id);
}


if (!empty($_POST['buyItemById'])) {
  $loggedInUser = $_SESSION['username'];
  $itemId = $_POST['buyItemById'];
  $result = buyItem($db, $itemId, $loggedInUser); 
  if ($result) {
    echo "<h5>成功购买物品</h5>";
  } else {
    echo "<h5>无法购买物品</h5>";
  }
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <script src="js/jquery.min.js"></script>
    <link rel="stylesheet" href="css/fontawesome.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/searchPage.css">
    <title>搜索结果</title>

    <script>
    function deleteItem(id) {
        document.getElementById('delItemById').value = id;
        $("#deleteItemForm").submit();
    }

    function buyItem(itemId) {
        document.getElementById('buyItemById').value = itemId;
        $("#buyItemForm").submit();
    }
    function validate(){tableau=["\'","<",">","\"","%"];var string =document.getElementById("searchTitle").value;for (var i in tableau){for (var j in string){if(tableau[i]==string[j]){return false;}}}}function validate2(){tableau=["\'","<",">","\"","%"];var string =document.getElementById("searchTitle").value;for (var i in tableau){
      for (var j in string){if(tableau[i]==string[j]){return false;}}}}
    </script>
</head>

<body style="background-image: url(assets/search.jpg); background-position: no-repeat;">
    <?php
    $page = "Search";
    require_once("navbar.php");
  ?>
    <div class="topImg" >
        <form class="form-inline p-2">
            <input name="searchTitle" id="searchTitle" class="form-control mr-sm-2 search" type="text"
                placeholder="按标题搜索" aria-label="Search">
            <button class="btn btn-outline-primary my-2 my-sm-0" type="submit" onclick="return validate();">搜索</button>
        </form>
     
        <h1 class="text-center pageTitle">
            搜索结果
            <?php
        if (!empty($_GET["searchTitle"])) {
          echo " For: ".filter_var($_GET["searchTitle"],FILTER_SANITIZE_STRING);
        }
      ?>
            <?php
        if(!empty($_GET["searchUser"])) {
          echo " For: ".$_GET["searchUser"];
        }
      ?>
        </h1>
    </div>

    <div class="card mr-4 ml-4 mb-4 searchTable" style="background-color: white; opacity: 0.85;">
        <table class="table itemsTable">
            <thead>
                <th>标题</th>
                <th>所有者姓名</th>
                <th>描述</th>
                <th>价格</th>
                <th>买</th>
            </thead>
            <tbody>
                <?php
          
          function constructBtn($ownersName, $id, $price) {
          $loggedInUser = $_SESSION['username'];
          $btnStr = "<button class='btn btn-success' onclick='buyItem(".$id.")'><i class='fas fa-shopping-cart'></button></i>";

          if ($ownersName === $loggedInUser) {
            $btnStr = "<button class='btn btn-danger pl-3 pr-3' onclick='deleteItem(".$id.")'><i class='fas fa-times'></button></i>";
          }

          return $btnStr;
        }

        if (isset($_GET["searchTitle"])) {
          $title = $_GET["searchTitle"];
          $sql = "SELECT * FROM items where title LIKE '%".$title."%'";
         } else if (isset($_GET["searchUser"])) {
          $name = $_GET["searchUser"];
          $sql = "SELECT * FROM items where ownersName LIKE '%$name%'";
         } else {
            $sql = "SELECT * FROM items";
         }
          $result = mysqli_query($db, $sql);

          while($row = mysqli_fetch_array($result)) {
            echo "<tr>";
             
              echo "<td>".$row["2"]."</td>";
              echo "<td>".$row["1"]."</td>";
              echo "<td>".$row["3"]."</td>";
              echo "<td>$".$row["4"]."</td>";
              // Access by name
              echo "<td>".constructBtn($row["ownersName"], $row["id"], $row["price"]) ."</td>";
            echo "</tr>";
          }
        ?>
            </tbody>
        </table>

    
        <form id="deleteItemForm" method='post' action="<?php echo $_SERVER['PHP_SELF']; ?>">
            <input name='delItemById' type='hidden' class='form-control' id='delItemById' placeholder='id'>
        </form>
      
        <form id="buyItemForm" method='post' action="<?php echo $_SERVER['PHP_SELF']; ?>">
            <input name='buyItemById' type='hidden' class='form-control' id='buyItemById' placeholder='id'>
        </form>
    </div>
</body>

</html>