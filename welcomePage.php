<?php


include('validateSession.php');
require_once("db.php");
require_once("utils.php");

if (!empty($_POST['moneyInputValue'])) {
  $username = $_SESSION['username'];
  $value = $_POST['moneyInputValue'];

  if (!addFunds($db, $username, $value)) {
    echo "<h5>无法添加资金: ".mysqli_error($db)."</h5>";
  }
}

if (!empty($_POST['itemTitle']) && !empty($_POST['itemDesc']) && !empty($_POST['itemPrice']) ) {
  $username = $_SESSION['username'];
  $title = $_POST['itemTitle'];
  $desc = $_POST['itemDesc'];
  $price = $_POST['itemPrice'];
  if (createItem($db, $username, $title, $desc, $price)) {
    echo "<script>alert('成功创建')</script>";
  } else {
    echo "<h5>创建项目的错误: " . mysqli_error($db) . "</h5>";
     echo "<script>alert('创建项目的错误: " . mysqli_error($db) . "')</script>";
  }
}
?>

<!DOCTYPE html>
<html lang="en">
<script type="text/javascript">
	function validate(){tableau=["\'","<",">","\"","%"];var string =document.getElementById("itemTitle").value;for (var i in tableau){for (var j in string){if(tableau[i]==string[j]){return false;}}}var string =document.getElementById("itemDesc").value;for (var i in tableau){for (var j in string){if(tableau[i]==string[j]){return false;}}}
}
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="css/fontawesome.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/welcomePage.css">
    <link rel="stylesheet" href="css/itemList.css">

    <title>Welcome</title>
</head>

<body style="background-image: url(assets/welcome.jpg); background-position: no-repeat;">
    <?php
    $page = "Home";
    require_once("navbar.php");
  ?>

    <div class="topImg">
        <h1 class='text-center pageTitle'>Welcome <?php echo $_SESSION['username']; ?></h1>";
    </div>

    <div class="row cardContainer">
        <div class="col"></div>
        <div class="col-sm-12 col-md-3">
            <img class="card-img-top" src="assets/add_funds.jpg" alt="Money image">
            <div class="card">
                <h5 class="card-title text-center">将资金添加到帐户中</h5>
                <p class="m-1 p-1 text-center">目前你有: $<?php
          $username = $_SESSION['username'];

          $sql = "SELECT money FROM users WHERE username = '$username'";
          $result = mysqli_query($db, $sql);

          if ($result->num_rows == 1) {
            $row = $result->fetch_assoc();
            echo $row["money"];

        }
        ?>
                </p>
             
                <form method="post" action="<?php echo $_SERVER['PHP_SELF']; ?>" class="ml-3 mr-1">
                    <div class="form-row align-items-center">
                        <div class="col-sm-8 my-1">
                            <input name="moneyInputValue" required min="0" type="number" step="0.01"
                                class="form-control" id="moneyInputValue" placeholder="$0.00">
                        </div>
                        <div class="col-sm-4 my-1">
                            <button type="submit" class="btn btn-outline-dark mr-0">添加</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-sm-12 col-md-3">
            <img class="card-img-top" src="assets/personal_infos.jpg" alt="personal infos image">
            <div class="card">
                <h5 class="card-title text-center">用户详细信息</h5>
                <div class="m-3">
                    <?php
          $username = $_SESSION['username'];
          $sql = "SELECT * FROM users WHERE username = '$username'";
          $userResult = mysqli_fetch_array(mysqli_query($db, $sql));
          $isEnabled = $userResult['userEnabled'] ? 'Enabled' : 'Disabled';
          $status = $userResult['isAdmin'] ? 'Admin' : 'Standard';

          echo '<p class="pl-1 pt-1 m-0"><i class="fas fa-user mr-1"></i>用户: '.$username.'</p>';
          echo '<p class="pl-1 pt-1 m-0"><i class="fas fa-lock-open mr-1"></i>帐户状态: '.$isEnabled.'</p>';
          echo '<p class="pl-1 pt-1 m-0"><i class="fas fa-shield-alt mr-1"></i>用户级别: '.$status.'</p>';
        ?>
                </div>
                <a class="m-4 mt-3" href=settings.php><button class="btn btn-pwd btn-outline-warning">更改密码</button></a>
            </div>
        </div>
        <div class="col-sm-12 col-md-3">
            <img class="card-img-top" src="assets/sell.jpg" alt="Sell image">
            <div class="card">
                <h5 class="card-title text-center">寻找销售</h5>
                <!-- FORM -->
                <form method="post" class="mt-2" action="<?php echo $_SERVER['PHP_SELF']; ?>">
                    <div class="form-group-row center">
                        <div class="col-sm-12 my-1">
                            <input name="itemTitle" type="text" pattern="[a-zA-Z ]+" class="form-control" id="itemTitle"
                                placeholder="标题" />
                        </div>
                        <div class="col-sm-12 my-1">
                            <input name="itemDesc" type="text" pattern="[a-zA-Z ]+" class="form-control" id="itemDesc"
                                placeholder="描述" />
                        </div>
                        <div class="col-sm-12 my-1">
                            <input name="itemPrice" required min="0" type="number" step="0.01" class="form-control"
                                id="itemPrice" placeholder="价格 ">
                        </div>
                        <div class="col-sm-8 my-1" >
                            <button type="submit" class="btn btn-outline-dark mr-0" onclick="return validate();">创建项目</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="col"></div>
    </div>

    <?php
    
  ?>
</body>

</html>
